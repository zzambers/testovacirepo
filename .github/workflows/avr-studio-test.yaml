name: "avr-studio-test"

on:
  push:
    branches:
      - "test-avr-studio"

jobs:
  avr-studio-install:
    name: "avr-studio-install"
    runs-on: "windows-2016"
    env:
      ARDUINO_VER: 1.8.13
      ATMEL_VER: 7.0.2389
    steps:
      - uses: actions/checkout@v2
      - name: Setup msys
        uses: msys2/setup-msys2@v2
        with:
          release: false
          install: psmisc unzip
      - name: Installers cache
        uses: actions/cache@v2
        working-directory: ${{ runner.temp }}
        with:
          path: |
            as-installer-${{ env.ARDUINO_VER }}-full.exe
            arduino-${{ env.ATMEL_VER }}-windows.zip
          key: ${{ env.ATMEL_VER }}-${{ env.ARDUINO_VER }}
      - name: Download installers
        shell: msys2 {0}
        working-directory: ${{ runner.temp }}
        timeout-minutes: 30
        run: |
          set -eux
          if ! [ -e as-installer-${ATMEL_VER}-full.exe ] ; then
              curl -L -f -o as-installer-${ATMEL_VER}-full.exe http://studio.download.atmel.com/${ATMEL_VER}/as-installer-${ATMEL_VER}-full.exe
          fi
          if ! [ -e arduino-${ARDUINO_VER}-windows.zip ] ; then
              curl -L -f -o arduino-${ARDUINO_VER}-windows.zip https://downloads.arduino.cc/arduino-${ARDUINO_VER}-windows.zip
          fi
      - name: Install arduino
        shell: msys2 {0}
        working-directory: ${{ runner.temp }}
        timeout-minutes: 30
        run: |
          set -eux
          PF="C:\\Program Files (x86)"
          unzip -d "${PF}" arduino-${ARDUINO_VER}-windows.zip
          mv "${PF}\\arduino-${ARDUINO_VER}" "${PF}\\Arduino"
          "${PF}\\Arduino\\arduino" --install-boards arduino:samd || true
      - name: Install AVR Strudio
        shell: msys2 {0}
        working-directory: ${{ runner.temp }}
        timeout-minutes: 30
        run: |
          set -eux
          ./as-installer-${ATMEL_VER}-full.exe -passive -norestart -log install.log &
          pid=$!
          sleep 5
          ps -W
          while kill -0 $pid ; do
              MSYS2_ARG_CONV_EXCL='/im;/f' taskkill /f /im drvinst.exe || true
              sleep 5
          done
          wait $pid || true
          [ -f install.log ]
          [ -d "C:\\Program Files (x86)\\Atmel\\Studio\\7.0\\" ]
      - name: Debug AVR studio install failures
        if: ${{ failure() }}
        shell: msys2 {0}
        working-directory: ${{ runner.temp }}
        run: |
          set -x
          ps -W
          cat install.log || true
